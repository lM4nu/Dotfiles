#!/bin/sh
file="$HOME/.local/share/dolar"

setvar(){
	compra=$(head -n1 "$file")
	venta=$(sed -n "2p" "$file")

	bluecompra=$(sed -n "3p" "$file")
	blueventa=$(sed -n "4p" "$file")

	mepcompra=$(sed -n "5p" "$file")
	mepventa=$(sed -n "6p" "$file")

	solidario=$(tail -n1 "$file")
}

update(){
	temp="$(mktemp)"

	curl -s "https://dolarhoy.com/cotizaciondolaroficial" > "$temp"
	curl -s "https://dolarhoy.com/cotizaciondolarblue" >> "$temp"
	curl -s "https://dolarhoy.com/cotizaciondolarbolsa" >> "$temp"
	curl -s "https://dolarhoy.com/cotizaciondolarsolidario" >> "$temp"

	grep -Eo "\"value\".{20}" "$temp" | grep -Eo "[0-9]*\.[0-9]*" > "$file"

	setvar
}

setvar

case $BLOCK_BUTTON in
	1) [ -z "$blueventa" ] || notify-send "ğŸ’µ Oficial ğŸ’µ" \
"Compra: <b>\$</b><b><span fgcolor=\"yellow\">$compra</span></b>
Venta:  <b>\$</b><b><span fgcolor=\"yellow\">$venta</span></b>

ğŸ’µ <b>Blue</b> ğŸ’µ
Compra: <b>\$</b><b><span fgcolor=\"yellow\">$bluecompra </span></b>
Venta:  <b>\$</b><b><span fgcolor=\"yellow\">$blueventa</span></b>

ğŸ’µ <b>Mep</b> ğŸ’µ
Compra: <b>\$</b><b><span fgcolor=\"yellow\">$mepcompra </span></b>
Venta:  <b>\$</b><b><span fgcolor=\"yellow\">$mepventa</span></b>

ğŸ’µ <b>Solidario</b> ğŸ’µ
Venta:  <b>\$</b><b><span fgcolor=\"yellow\">$solidario</span></b>" ;;
	2) update ;;
	3) "$TERMINAL" -e "$EDITOR" "$0";;
esac

#once per day
#[ "$(stat -c %y "$file" | cut -d' ' -f1)" !=  "$(date -I)" ] && update
# every 5 minutes
moddate="$(date -r "$file" '+%s')"
actualdate="$(date '+%s')"
diff="$(( (actualdate - moddate) / 60 ))"
[ "$diff" -lt 5 ] || update

[ -z "$blueventa" ] || echo " $blueventa"
