#!/bin/sh

if [ -z "$1" ]
then
	query="$(printf "" | dmenu -p "search: " | tr ' ' '+')"
else
	query="$(echo "$1" | tr ' ' '+')"
fi

if [ -z "$query" ]
then
	exit 1
fi

file="$(mktemp)"
titles="$(mktemp)"
urls="$(mktemp)"
list="$(mktemp)"

curl -s "https://invidious.snopyta.org/search?q=$query" > $file

grep -A 9 -B 2 "<div class=\"thumbnail\">" $file | grep "href\|auto" | grep -o "href.*\|>.*" | sed "s/^>//;s/<\/p>$//;s/>$//;s/\"$//;s/href=\"/https:\/\/www\.youtube\.com/" | head -n-4 | grep "http.*" > "$urls"

grep -A 9 -B 2 "<div class=\"thumbnail\">" $file | grep "href\|auto" | grep -o "href.*\|>.*" | sed "s/^>//;s/<\/p>$//;s/>$//;s/\"$//;s/href=\"/https:\/\/www\.youtube\.com/" | head -n-4 | grep -v "http.*" > "$titles"

paste -d@ "$titles" "$urls" | while IFS="@" read -r f1 f2
do
  printf '%s' "$f1"
  echo ";$f2"
done > $list

chosen="$(cut -d';' -f1 "$list" | dmenu -i -l 30)"

if [ -z "$chosen" ]
then
	exit 1
fi

setsid -f mpv --no-terminal "$(grep "$chosen;" "$list" | cut -d';' -f2)" 2> /dev/null || notify-send "Error"

rm "$file" "$titles" "$urls" "$list"
