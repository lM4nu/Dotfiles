#!/bin/sh

if [ -z "$1" ]
then
	query="$(printf "" | dmenu -p "search: " | tr ' ' '+')"
else
	query="$(echo "$1" | tr ' ' '+')"
fi

if [ -z "$query" ]
then
	exit 1
fi

html="$(mktemp)"
file="$(mktemp)"
titles="$(mktemp)"
urls="$(mktemp)"
channels="$(mktemp)"
menu="$(mktemp)"

curl -s "https://invidious.snopyta.org/search?q=$query" > "$html"
sed -i "s/&#39;/'/g;s/&quot;/\"/g" "$html"

grep -A 14 -B 2 "<div class=\"thumbnail\">" "$html" | grep "href\|auto" | grep -v "\/channel" | grep -v "class=\"length" | sed "/playlist?/,+2 d;s/.*href=\"/https:\/\/www\.youtube\.com/;s/\">$//;s/.*<p dir=\"auto\">/VIDEOTITLE;/;s/<\/p>$//;s/.*<p class=\".*>/CHANNELNAME;/" > "$file"

grep "/watch?v=" "$file" > "$urls"
grep "VIDEOTITLE" "$file" | cut -d';' -f2 > "$titles"
grep "CHANNELNAME" "$file" | cut -d';' -f2 > "$channels"

paste -d@ "$urls" "$titles" "$channels" | while IFS="@" read -r f1 f2 f3
do
  printf '%s;%s by %s\n' "$f1" "$f2" "$f3"
done > "$menu"

chosen="$(cut -d';' -f2 "$menu" | dmenu -i -l 30)"

if [ -z "$chosen" ]
then
	exit 1
fi

yturl="$(grep -F ";$chosen" "$menu" | cut -d';' -f1)"

printf "%s" "$yturl" | xsel -bi

notify-send "Playing $chosen in mpv"

setsid -f mpv --no-terminal "$yturl" 2> /dev/null || notify-send "Error"

rm "$html" "$file" "$titles" "$urls" "$channels" "$menu"
