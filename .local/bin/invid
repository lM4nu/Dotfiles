#!/bin/sh

if [ -z "$1" ]
then
	query="$(printf "" | dmenu -p "search: " | tr ' ' '+')"
else
	query="$(echo "$1" | tr ' ' '+')"
fi

if [ -z "$query" ]
then
	exit 1
fi

html="$(mktemp)"
file="$(mktemp)"
titles="$(mktemp)"
urls="$(mktemp)"
channels="$(mktemp)"
menu="$(mktemp)"
instance="https://invidious.snopyta.org"
#instance="https://invidious.flokinet.to"

clean(){
	rm "$html" "$file" "$titles" "$urls" "$channels" "$menu"
}

curl -s "$instance/search?q=$query" > "$html"
#sed -i "s/&#39;/'/g;s/&quot;/\"/g;s/&amp;/\&/g" "$html"
recode HTML_4.0 "$html"

grep -A 14 -B 2 "<div class=\"thumbnail\">" "$html" | grep "href\|auto" | grep -v "\/channel" | grep -v "class=\"length" | sed "/playlist?/,+2 d;s/.*href=\"/https:\/\/www\.youtube\.com/;s/\">$//;s/.*<p dir=\"auto\">/VIDEOTITLE;/;s/.*<p class=\".*auto\">/CHANNELNAME;/;s/<\/p>$//;s/<i.*<\/i>$//" > "$file"

grep "/watch?v=" "$file" > "$urls"
grep "VIDEOTITLE" "$file" | cut -d';' -f2 > "$titles"
grep "CHANNELNAME" "$file" | cut -d';' -f2 > "$channels"

paste -d@ "$urls" "$titles" "$channels" | while IFS="@" read -r f1 f2 f3
do
  printf '%s;%s by %s\n' "$f1" "$f2" "$f3"
done > "$menu"

chosen="$(cut -d';' -f2 "$menu" | dmenu -i -l 30)"

if [ -z "$chosen" ]
then
	clean ; exit 1
fi

yturl="$(grep -F ";$chosen" "$menu" | cut -d';' -f1)"
url="$(echo "$yturl" | sed "s|https://www.youtube.com|$instance|")"

#printf "%s" "$yturl" | xsel -bi
printf "%s" "$url" | xsel -bi

notify-send "Playing $chosen in mpv"

setsid -f mpv --no-terminal "$yturl" 2> /dev/null || notify-send "Error"

clean
