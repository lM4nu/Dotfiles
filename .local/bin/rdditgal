#!/bin/bash
galleryfile="${XDG_CACHE_HOME:-$HOME/.cache}/newsboat/source"
cachedir="${XDG_CACHE_HOME:-$HOME/.cache}/newsboat"

curl -s "$1" > "$galleryfile"
content=$(cat "$galleryfile")

while [ "$content" = "Internal Server Error" ]
do
curl -s "$1" > "$galleryfile"
content=$(cat $galleryfile)
done

grep "Sorry, this post" $galleryfile >/dev/null && notify-send "Banned Post" && rm $galleryfile && exit

links=$(grep -Eo "https://preview\.redd\.it/.{1,110}\"" $galleryfile | sed "/\\\u/ d;s/\".*\"$//g;s/\"$//;s/amp;//g" | uniq -w 37)

counter=0
while read p; do
	wget -O $cachedir/gal$counter.jpg "$p" 2> /dev/null
	counter=$((counter + 1))
done <<< $links

ls --sort width $cachedir/gal*jpg | sxiv -i && rm $cachedir/*
